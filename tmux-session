#!/bin/bash

# Tmux session manager with try integration
# Usage:
#   tmux-session                     # Interactive try selector (or current dir if try not installed)
#   tmux-session ./path              # Use explicit directory path
#   tmux-session ~/projects/app      # Use home-relative path
#   tmux-session /absolute/path      # Use absolute path
#   tmux-session myproject           # tmuxinator project or try experiment name
#   tmux-session https://github.com/user/repo  # Clone and start session
#   tmux-session git@github.com:user/repo      # Clone via SSH

set -e

# Check if tmuxinator is available
HAS_TMUXINATOR=false
if command -v tmuxinator >/dev/null 2>&1; then
  HAS_TMUXINATOR=true
fi

# Check if try is available
HAS_TRY=false
if command -v try >/dev/null 2>&1; then
  HAS_TRY=true
fi

# Get try configuration
TRY_PATH="${TRY_PATH:-$HOME/src/tries}"

# Function to show try installation instructions
show_try_install_help() {
  echo "" >&2
  echo "Please install 'try' first:" >&2
  echo "  gem install try-cli" >&2
  echo "  # or" >&2
  echo "  cargo install try-cli" >&2
  echo "  # or" >&2
  echo "  brew tap tobi/try https://github.com/tobi/try" >&2
  echo "  brew install try" >&2
  echo "" >&2
  echo "Then add to your shell config:" >&2
  echo "  eval \"\$(try init)\"" >&2
  echo "" >&2
  echo "For more info: https://github.com/tobi/try" >&2
}

# Function to execute try and get target directory
run_try() {
  local try_args=("$@")
  
  # Use try exec with proper TTY handling (mimics try shell function)
  # Redirect stderr to /dev/tty to allow interactive selector
  local try_script
  try_script=$(try exec --path "$TRY_PATH" "${try_args[@]}" 2>/dev/tty)
  local try_exit_code=$?
  
  # Check if try was cancelled or failed
  if [[ $try_exit_code -ne 0 ]]; then
    exit 1
  fi
  
  # Check if output is empty
  if [[ -z "$try_script" ]]; then
    echo "Error: No directory selected" >&2
    exit 1
  fi
  
  # Extract the target directory from the try exec output
  local target_dir
  target_dir=$(echo "$try_script" | grep -o "cd '[^']*'" | head -1 | cut -d"'" -f2)
  if [[ -z "$target_dir" ]]; then
    target_dir=$(echo "$try_script" | grep -o 'cd .*' | head -1 | cut -d' ' -f2- | tr -d '"' | tr -d "'")
  fi
  
  if [[ -z "$target_dir" ]]; then
    echo "Error: Could not determine target directory" >&2
    exit 1
  fi
  
  # Execute the try script (this will create directories, clone repos, etc.)
  eval "$try_script"
  
  # Return the target directory
  echo "$target_dir"
}

# Function to check if argument is a Git URL
is_git_url() {
  local arg="$1"
  # Match https://*.git, https://github.com/*, git@*:*, etc.
  if [[ "$arg" =~ ^https?:// ]] || [[ "$arg" =~ ^git@ ]]; then
    return 0
  fi
  return 1
}

# Function to check if argument is a path (starts with ./, ~/, or /)
is_path() {
  local arg="$1"
  if [[ "$arg" =~ ^\./ ]] || [[ "$arg" =~ ^~/ ]] || [[ "$arg" =~ ^/ ]]; then
    return 0
  fi
  return 1
}

# Function to start tmux session in a directory
start_session_in_dir() {
  local project_dir="$1"
  
  # Create project directory if it doesn't exist
  mkdir -p "$project_dir"
  
  # Change to project directory
  cd "$project_dir"
  
  # Get absolute path
  project_dir="$(pwd)"
  
  # Generate session name from directory name
  local session_name
  session_name=$(basename "$project_dir" | tr '.' '_')
  
  # Check if tmux session already exists
  if tmux has-session -t "$session_name" 2>/dev/null; then
    echo "Attaching to existing tmux session: $session_name"
    if [[ -n "$TMUX" ]]; then
      tmux switch-client -t "$session_name"
    else
      tmux attach-session -t "$session_name"
    fi
    return 0
  fi
  
  # Use tmuxinator if available
  if [[ "$HAS_TMUXINATOR" == "true" ]]; then
    # Create .tmuxinator.yml if it doesn't exist
    if [[ ! -f ".tmuxinator.yml" ]]; then
      echo "Creating .tmuxinator.yml..."
      cat >.tmuxinator.yml <<'EOF'
# .tmuxinator.yml

name: <%= File.basename(Dir.pwd).gsub('.', '_') %>
root: <%= Dir.pwd %>

windows:
  - main:
      panes:
        - zsh
        - opencode
EOF
      echo ".tmuxinator.yml created"
    fi

    # Run tmuxinator local
    echo "Starting tmuxinator with local config..."
    tmuxinator local
  else
    # Fallback: Create tmux session directly without tmuxinator
    echo "Starting tmux session: $session_name (tmuxinator not available)"
    
    # Create and attach to new session
    if [[ -n "$TMUX" ]]; then
      # Already inside tmux, create detached and switch
      tmux new-session -d -s "$session_name" -c "$project_dir"
      tmux switch-client -t "$session_name"
    else
      # Not inside tmux, create and attach directly
      tmux new-session -s "$session_name" -c "$project_dir"
    fi
  fi
}

# Main logic
ARG="${1:-}"

# Case 1: Git URL - requires try
if [[ -n "$ARG" ]] && is_git_url "$ARG"; then
  if [[ "$HAS_TRY" != "true" ]]; then
    echo "Error: 'try' command not found" >&2
    echo "" >&2
    echo "Git URL cloning requires 'try' for experiment management." >&2
    show_try_install_help
    exit 1
  fi
  
  TARGET_DIR=$(run_try "$@")
  start_session_in_dir "$TARGET_DIR"
  exit 0
fi

# Case 2: Explicit path (./, ~/, /)
if [[ -n "$ARG" ]] && is_path "$ARG"; then
  # Expand ~ if present
  ARG="${ARG/#\~/$HOME}"
  start_session_in_dir "$ARG"
  exit 0
fi

# Case 3: No argument - try selector or current directory
if [[ -z "$ARG" ]]; then
  if [[ "$HAS_TRY" == "true" ]]; then
    TARGET_DIR=$(run_try)
    start_session_in_dir "$TARGET_DIR"
  else
    start_session_in_dir "."
  fi
  exit 0
fi

# Case 4: Name only (no path separators)
# First check if it's a tmuxinator project
if [[ "$HAS_TMUXINATOR" == "true" ]]; then
  TMUXINATOR_PROJECTS=$(tmuxinator list 2>/dev/null | tail -n +2 | tr -d '\n')
  
  if echo "$TMUXINATOR_PROJECTS" | grep -q "\b$ARG\b"; then
    echo "Starting tmuxinator project: $ARG"
    tmuxinator start "$ARG"
    exit 0
  fi
fi

# Not a tmuxinator project - use try
if [[ "$HAS_TRY" != "true" ]]; then
  echo "Error: 'try' command not found" >&2
  echo "" >&2
  echo "Name-based sessions require 'try' for experiment management." >&2
  echo "" >&2
  echo "Please either:" >&2
  echo "  1. Install 'try' (see below)" >&2
  echo "  2. Use explicit path: tmux-session ./$ARG" >&2
  show_try_install_help
  exit 1
fi

TARGET_DIR=$(run_try "$@")
start_session_in_dir "$TARGET_DIR"
