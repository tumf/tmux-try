#!/bin/bash

# Tmux session manager with optional tmuxinator support
# Usage: ./tmux-session [<project-dir>|<tmuxinator-name>]
#        ./tmux-session --try <experiment-name|git-url>
# Supported Git URLs: https://github.com/user/repo, git@github.com:user/repo, etc. (.git optional)

set -e

# Check if tmuxinator is available
HAS_TMUXINATOR=false
if command -v tmuxinator >/dev/null 2>&1; then
  HAS_TMUXINATOR=true
fi

# Check for --try option
if [[ "$1" == "--try" ]]; then
  # Check if try is installed
  if ! command -v try >/dev/null 2>&1; then
    echo "Error: 'try' command not found" >&2
    echo "" >&2
    echo "Please install 'try' first:" >&2
    echo "  gem install try-cli" >&2
    echo "  # or" >&2
    echo "  cargo install try-cli" >&2
    echo "  # or" >&2
    echo "  brew tap tobi/try https://github.com/tobi/try" >&2
    echo "  brew install try" >&2
    echo "" >&2
    echo "Then add to your shell config:" >&2
    echo "  eval \"\$(try init)\"" >&2
    exit 1
  fi

  shift  # Remove --try
  
  # Get try configuration
  TRY_PATH="${TRY_PATH:-$HOME/src/tries}"
  
  # Use try exec with proper TTY handling (mimics try shell function)
  # Redirect stderr to /dev/tty to allow interactive selector
  TRY_SCRIPT=$(try exec --path "$TRY_PATH" "$@" 2>/dev/tty)
  TRY_EXIT_CODE=$?
  
  # Check if try was cancelled or failed
  if [[ $TRY_EXIT_CODE -ne 0 ]]; then
    # Silent exit on cancellation (user pressed Ctrl-C or ESC)
    exit 1
  fi
  
  # Check if output is empty
  if [[ -z "$TRY_SCRIPT" ]]; then
    echo "Error: No directory selected" >&2
    exit 1
  fi
  
  # Extract the target directory from the try exec output before executing
  # The output is typically "cd <directory>" or a script that includes "cd <directory>"
  TARGET_DIR=$(echo "$TRY_SCRIPT" | grep -o "cd '[^']*'" | head -1 | cut -d"'" -f2)
  if [[ -z "$TARGET_DIR" ]]; then
    TARGET_DIR=$(echo "$TRY_SCRIPT" | grep -o 'cd .*' | head -1 | cut -d' ' -f2- | tr -d '"' | tr -d "'")
  fi
  
  if [[ -z "$TARGET_DIR" ]]; then
    echo "Error: Could not determine target directory" >&2
    exit 1
  fi
  
  # Execute the try script (this will create directories, clone repos, etc.)
  eval "$TRY_SCRIPT"
  
  # Set ARG to the directory try selected/created
  ARG="$TARGET_DIR"
else
  # Use current directory if no argument is provided
  if [ $# -eq 0 ]; then
    ARG="."
  else
    ARG="$1"
  fi
fi

# Check if tmuxinator is available and argument is a tmuxinator project name
if [[ "$HAS_TMUXINATOR" == "true" ]]; then
  TMUXINATOR_PROJECTS=$(tmuxinator list 2>/dev/null | tail -n +2 | tr -d '\n')
  
  if echo "$TMUXINATOR_PROJECTS" | grep -q "\b$ARG\b"; then
    # Argument is a tmuxinator project name
    echo "Starting tmuxinator project: $ARG"
    tmuxinator start "$ARG"
    exit 0
  fi
fi

# Argument is treated as a project directory
PROJECT_DIR="$ARG"

# Create project directory if it doesn't exist
mkdir -p "$PROJECT_DIR"

# Change to project directory
cd "$PROJECT_DIR"

# Get absolute path
PROJECT_DIR="$(pwd)"

# Generate session name from directory name
SESSION_NAME=$(basename "$PROJECT_DIR" | tr '.' '_')

# Check if tmux session already exists
if tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  echo "Attaching to existing tmux session: $SESSION_NAME"
  if [[ -n "$TMUX" ]]; then
    tmux switch-client -t "$SESSION_NAME"
  else
    tmux attach-session -t "$SESSION_NAME"
  fi
  exit 0
fi

# Use tmuxinator if available and .tmuxinator.yml exists or can be created
if [[ "$HAS_TMUXINATOR" == "true" ]]; then
  # Create .tmuxinator.yml if it doesn't exist
  if [[ ! -f ".tmuxinator.yml" ]]; then
    echo "Creating .tmuxinator.yml..."
    cat >.tmuxinator.yml <<'EOF'
# .tmuxinator.yml

name: <%= File.basename(Dir.pwd).gsub('.', '_') %>
root: <%= Dir.pwd %>

windows:
  - main:
      panes:
        - zsh
        - opencode
EOF
    echo ".tmuxinator.yml created"
  fi

  # Run tmuxinator local
  echo "Starting tmuxinator with local config..."
  tmuxinator local
else
  # Fallback: Create tmux session directly without tmuxinator
  echo "Starting tmux session: $SESSION_NAME (tmuxinator not available)"
  
  # Create and attach to new session
  if [[ -n "$TMUX" ]]; then
    # Already inside tmux, create detached and switch
    tmux new-session -d -s "$SESSION_NAME" -c "$PROJECT_DIR"
    tmux switch-client -t "$SESSION_NAME"
  else
    # Not inside tmux, create and attach directly
    tmux new-session -s "$SESSION_NAME" -c "$PROJECT_DIR"
  fi
fi
