#!/bin/bash

# try-tmux: Create experiment directory with try and start tmux session
# Usage: try-tmux [experiment-name|git-url] [additional-try-args...]
# Examples:
#   try-tmux                            # Interactive selector
#   try-tmux redis                      # Filter by "redis"
#   try-tmux redis-experiment           # Create new experiment
#   try-tmux https://github.com/tobi/try  # Clone repo
#   try-tmux git@github.com:user/repo   # Clone via SSH
# Note: Works with or without tmuxinator installed. .git suffix is optional.

set -e

# Check if try is installed
if ! command -v try >/dev/null 2>&1; then
  echo "Error: 'try' command not found" >&2
  echo "" >&2
  echo "Please install 'try' first:" >&2
  echo "  gem install try-cli" >&2
  echo "  # or" >&2
  echo "  cargo install try-cli" >&2
  echo "  # or" >&2
  echo "  brew tap tobi/try https://github.com/tobi/try" >&2
  echo "  brew install try" >&2
  echo "" >&2
  echo "Then add to your shell config:" >&2
  echo "  eval \"\$(try init)\"" >&2
  exit 1
fi

# Check if tmux-session is available
TMUX_SESSION_CMD=""
if command -v tmux-session >/dev/null 2>&1; then
  TMUX_SESSION_CMD="tmux-session"
elif [[ -x "./tmux-session" ]]; then
  TMUX_SESSION_CMD="./tmux-session"
else
  echo "Error: 'tmux-session' command not found" >&2
  echo "Please ensure tmux-session is in your PATH or current directory" >&2
  exit 1
fi

# Get try configuration
TRY_PATH="${TRY_PATH:-$HOME/src/tries}"

# Use try exec with proper TTY handling (mimics try shell function)
# Redirect stderr to /dev/tty to allow interactive selector
TRY_SCRIPT=$(try exec --path "$TRY_PATH" "$@" 2>/dev/tty)
TRY_EXIT_CODE=$?

# Check if try was cancelled or failed
if [[ $TRY_EXIT_CODE -ne 0 ]]; then
  # Silent exit on cancellation (user pressed Ctrl-C or ESC)
  exit 1
fi

# Check if output is empty
if [[ -z "$TRY_SCRIPT" ]]; then
  echo "Error: No directory selected" >&2
  exit 1
fi

# Extract the target directory from the try exec output before executing
# The output is typically "cd <directory>" or a script that includes "cd <directory>"
TARGET_DIR=$(echo "$TRY_SCRIPT" | grep -o "cd '[^']*'" | head -1 | cut -d"'" -f2)
if [[ -z "$TARGET_DIR" ]]; then
  TARGET_DIR=$(echo "$TRY_SCRIPT" | grep -o 'cd .*' | head -1 | cut -d' ' -f2- | tr -d '"' | tr -d "'")
fi

if [[ -z "$TARGET_DIR" ]]; then
  echo "Error: Could not determine target directory" >&2
  exit 1
fi

# Execute the try script (this will create directories, clone repos, etc.)
eval "$TRY_SCRIPT"

# Start tmux session in the selected/created directory
"$TMUX_SESSION_CMD" "$TARGET_DIR"
